<!DOCTYPE html>
<meta charset="utf-8"/>
<title>WebSocket Test</title>
<style>
    html { background: #f1f1f1; color: #333; font-family: sans-serif; }
    .caller { padding: 10px; margin: 20px; background: #fff; border: 1px solid #ccc;}
</style>
<script language="javascript" type="text/javascript">

  const wsUri = 'ws://localhost:3000/dashboard'
  let output

  function init () {
    output = document.getElementById('output')
    testWebSocket()
  }

  function testWebSocket () {
    websocket = new WebSocket(wsUri)
    websocket.onopen = onOpen
    websocket.onclose = onClose
    websocket.onmessage = onMessage
    websocket.onerror = onError
  }

  function onOpen (/*evt*/) {
  }

  function onClose (/*evt*/) {
  }

  function onMessage (evt) {
    writeToScreen(parseResponse(evt))
  }

  function onError (evt) {
    writeToScreen(parseResponse(evt))
  }

  function parseResponse(evt) {
    try {
      const connections = JSON.parse(evt.data)
      return Object.entries(connections).map(([id, userData]) => ({ id, ...userData}))
    } catch (e) {
      console.log(e)
    }
  }

  function renderLocation(location) {
    return `
        <div>
            <hr>
            <p>Latitude <strong>${location.coords.latitude}</strong></p>
            <p>Longitude <strong>${location.coords.longitude}</strong></p>
        </div>
    `
  }

  function writeToScreen (connections) {
    output.innerHTML = ''
    if (connections.length === 0) return output.innerHTML = '<h4>No connected callers</h4>'
    connections.map(({id, profile, location}) => {
      output.insertAdjacentHTML('beforeend', `
        <div class="caller" id="${id}">
            <small>Connected caller</small>
            <h4>${profile.name}</h4>
            <p>Bloodtype <strong>${profile.bloodType}</strong></p>
            <p>Allergies <strong>${profile.allergies}</strong></p>
            <p>Medical conditions <strong>${profile.medicalConditions}</strong></p>
            <hr>
            <h6>Next of kin</h6>
            <h4>${profile.nextOfKin.name}</h4>
            <p>Relationship <strong>${profile.nextOfKin.relationship}</strong></p>
            <p>Phone <strong>${profile.nextOfKin.contactNumber}</strong></p>
            ${ location ? renderLocation(location) : ''}
        </div>
        `)
    })
  }

  window.addEventListener('load', init, false)

</script>

<h2>Dashboard</h2>
<div id="output"></div>
